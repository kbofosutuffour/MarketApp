{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'chat_messaging.css' %}" >
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <title>H2H | Chatroom</title>
</head>
<body>
    <div id = 'top-bar' style="width: 100%; margin-bottom: 5px;">

        {% if user.is_authenticated %}
            <div style="margin-right: 90%; display: inline; width: fit-content;"><h2 style="position: relative; top:25%">Chats</h2></div>
      {% endif %}

    </div>
    
    <div id="chat-window" >
        <script type="text/javascript">
            function scroll() {
                var element = document.getElementById('chat-window');
                element.scrollTop = element.scrollHeight;
                var b = document.body;
                b.style.backgroundColor = "red"
                // setInterval(updateScroll,1000)
            }
        </script>
        
    </div>

    <!-- Script used to dynamically and asyncronousely retrieve chat messages from the database
    and display them on screen in "real time" -->
    <script type="text/javascript">
        $(document).ready(function(){
            setInterval(function() {
                $.ajax({
                    type: 'GET',
                    url: "load_messages/{{username1}}/{{username2}}/{{current_user}}",
                    success: function(response) {
                        $("#chat-window").empty();
                        for (var key in response.messages) {
                            var temp = "<div class=\"chat\">";
                                console.log(response.messages)
                                if (response.username1 == response.messages[key].username) {
                                    temp += "<div class=\"chat-image-div\" display=\"inline-block\" ><img class=\"chat-image\" src=\"" + response.profile_picture1 + "\"/></div>";
                                } else if (response.username2 == response.messages[key].username) {
                                    temp += "<div class=\"chat-image-div\" display=\"inline-block\" ><img class=\"chat-image\" src=\"" + response.profile_picture2 + "\"/></div>";
                                }
                            temp += "<div class =\"chat-text\" display=\"inline-block\" ><div><p class='chat-username'>" + response.messages[key].username + "</p></div><div><p class='chat-value'>" + response.messages[key].value + "</p></div><div><p class='chat-date'>" + response.messages[key].date + "</p></div><div class=\"chat-bubble\"></div></div></div>";
                            $("#chat-window").append(temp);
                        }
                        
                    },
                    error: function(response) {
    
                    }


                });
            });

            })

        // $(document).ready(function() {
        //     var h = $("#chat-window")[0].scrollHeight;
        //     console.log('testing again');
        //     console.log(h);
        //     // document.getElementById('#chat-window').scrollHeight = 400
        //     t = $("#chat-window")[0].scrollTop;
        //     console.log(t);
        //     $("#chat-window").get(0).scrollTo(h);

        
        //     }
        // )

        // });
    </script>

    <div id="keyboard">
        <form id="message-form" style="display: inline;">
            {% csrf_token %}
            <input id="keyboard-text" type="text" name="new_message">
            <input type="hidden" id="username1" name="username1" value="{{username1}}">
            <input type="hidden" id="username2" name="username2" value="{{username2}}">
            <input type="hidden" id="product" name="product" value="{{product}}">
            <input type="hidden" id="current_user" name="current_user" value="{{current_user}}">
            <!-- <input type="hidden" id="room_id" name="room_id" value="{{chatroom.details.id}}"> -->

            <input id="send" type="submit">
        </form>

    </div>

    <!-- Script used to save a message into a Message model (save the message into the database) -->
    <script type="text/javascript">
        $(document).on('submit','#message-form',function(e){
          e.preventDefault();
      
          $.ajax({
            type:'POST',
            url:'/new_message',
            data:{
                new_message: $('#keyboard-text').val(),
                current_user: $('#current_user').val(),
                username1: $('#username1').val(),
                username2: $('#username2').val(),
                product: $('#product').val(),
                csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            },
            success: function(data){
               //alert(data)
            }
          });
          document.getElementById('keyboard-text').value = '';

        });
      </script>


    <footer>
        <ul>
            <li class = "footer_img"><a href="returnHome"><img src="{% static 'media/home.png' %}" id="home"/></a></li>
            <li class = "footer_img"><a href="chat_room" id="to-chat"><img src="{% static 'media/chat.png' %}" id="chats"/></a></li>
            <li class = "footer_img"><a href="profile" id="to-profile"><img src="{% static 'media/profile.png' %}" id="profile" /></a></li>
        </ul>
   </footer>
    
</body>

</html>